<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ポケモンタイムアタック</title>

<style>
body {
  font-family: system-ui, sans-serif;
  margin: 0;
  padding: 10px;
  background: #f5f5f5;
}

.container {
  max-width: 500px;
  margin: auto;
  background: white;
  padding: 15px;
  border-radius: 10px;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

h1 {
  text-align: center;
  font-size: 1.4em;
}

select, input, button {
  width: 100%;
  font-size: 1.1em;
  padding: 10px;
  margin: 8px 0;
}

#status {
  text-align: center;
  font-size: 1.1em;
  margin: 10px 0;
}

#timer {
  font-weight: bold;
  color: red;
}

.hidden {
  display: none;
}
</style>
</head>

<body>
<div class="container">
  <h1>ポケモンタイムアタック</h1>

  <label>制限時間</label>
  <select id="timeSelect">
    <option value="0">制限時間なし</option>
    <option value="1">1秒</option>
    <option value="2">2秒</option>
    <option value="3">3秒</option>
    <option value="4">4秒</option>
    <option value="5" selected>5秒</option>
    <option value="6">6秒</option>
    <option value="7">7秒</option>
    <option value="8">8秒</option>
    <option value="9">9秒</option>
    <option value="10">10秒</option>
  </select>

  <div id="bestBox">
    最高記録：<span id="best">0</span>
  </div>

  <button onclick="startGame()">ゲーム開始</button>

  <div id="game" class="hidden">
    <div id="status">
      No.<span id="number"></span><br>
      ⏱ <span id="timer"></span><br>
      正解数：<span id="score">0</span>
    </div>

    <input
      id="answer"
      list="pokemonList"
      placeholder="ポケモン名を入力"
      autocomplete="off"
    >
    <datalist id="pokemonList"></datalist>
  </div>
</div>

<script>
/* =========================
   共通データ
========================= */
let pokemon = {};
let numbers = [];
let currentNumber = null;
let timer = null;
let timeLeft = 0;
let limit = 5;
let score = 0;

/* =========================
   日本語正規化（完全対応）
   ・ひらがな→カタカナ
   ・全角→半角
   ・濁音・半濁音・ッ対応
========================= */
function normalizeJP(str) {
  if (!str) return "";

  return str
    // ひらがな → カタカナ
    .replace(/[\u3041-\u3096]/g, ch =>
      String.fromCharCode(ch.charCodeAt(0) + 0x60)
    )
    // 全角カタカナ → 半角
    .normalize("NFKC")
    // 大文字小文字の差を消す（念のため）
    .toUpperCase();
}

/* =========================
   JSON読み込み
========================= */
fetch("pokemon.json")
  .then(r => r.json())
  .then(data => {
    pokemon = data;
    numbers = Object.keys(pokemon);
    updateBest();
  })
  .catch(() => alert("pokemon.json の読み込みに失敗しました"));

/* =========================
   時間別最高記録
========================= */
function bestKey() {
  return "pokemon_best_" + limit;
}

function updateBest() {
  const best = localStorage.getItem(bestKey()) || 0;
  document.getElementById("best").textContent = best;
}

document.getElementById("timeSelect").addEventListener("change", () => {
  limit = Number(timeSelect.value);
  updateBest();
});

/* =========================
   ゲーム開始
========================= */
function startGame() {
  score = 0;
  limit = Number(timeSelect.value);
  document.getElementById("score").textContent = score;
  document.getElementById("game").classList.remove("hidden");
  updateBest();
  nextQuestion();
}

/* =========================
   次の問題
========================= */
function nextQuestion() {
  clearInterval(timer);

  if (limit === 0) {
    timer.textContent = "∞";
  } else {
    timeLeft = limit;
    timer.textContent = timeLeft;
    timer = setInterval(() => {
      timeLeft--;
      document.getElementById("timer").textContent = timeLeft;
      if (timeLeft <= 0) gameOver("時間切れ！");
    }, 1000);
  }

  currentNumber = numbers[Math.floor(Math.random() * numbers.length)];
  document.getElementById("number").textContent = currentNumber;

  answer.value = "";
  answer.focus();
}

/* =========================
   予測変換（完全対応）
========================= */
answer.addEventListener("input", () => {
  const text = answer.value;
  pokemonList.innerHTML = "";

  if (!text) return;

  numbers.forEach(n => {
    if (
      normalizeJP(pokemon[n])
        .startsWith(normalizeJP(text))
    ) {
      const o = document.createElement("option");
      o.value = pokemon[n];
      pokemonList.appendChild(o);
    }
  });
});

/* =========================
   Enterキー判定
========================= */
answer.addEventListener("keydown", e => {
  if (e.key === "Enter") {
    e.preventDefault();
    checkAnswer();
  }
});

/* =========================
   判定
========================= */
function checkAnswer() {
  const input = answer.value.trim();

  if (
    normalizeJP(input) ===
    normalizeJP(pokemon[currentNumber])
  ) {
    score++;
    document.getElementById("score").textContent = score;
    nextQuestion();
  } else {
    gameOver(
      "不正解！\n正解：" + pokemon[currentNumber]
    );
  }
}

/* =========================
   ゲームオーバー
========================= */
function gameOver(reason) {
  clearInterval(timer);

  const key = bestKey();
  const best = Number(localStorage.getItem(key) || 0);

  if (score > best) {
    localStorage.setItem(key, score);
  }

  alert(
    `${reason}\nスコア：${score}\n最高記録：${Math.max(score, best)}`
  );

  updateBest();
  document.getElementById("game").classList.add("hidden");
}
</script>
</body>
</html>
