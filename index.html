<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ポケモン図鑑番号検定</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: sans-serif;
  padding: 10px;
}

h1 {
  font-size: 20px;
}

button, select {
  font-size: 16px;
  padding: 6px;
  margin: 4px 0;
}

#gameArea {
  margin-top: 10px;
}

#question {
  font-size: 22px;
  margin: 10px 0;
}

input[type="text"] {
  font-size: 18px;
  width: 100%;
  padding: 6px;
}

#message {
  margin: 8px 0;
  min-height: 1.5em;
}

#timer {
  margin: 6px 0;
}

#result {
  margin: 10px 0;
}

.generations {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 6px;
  margin: 10px 0;
}

.gen-box {
  border: 1px solid #aaa;
  padding: 6px;
  position: relative;
  min-height: 40px;
}

.gen-box span {
  display: block;
  margin-bottom: 8px;
}

.gen-box input {
  position: absolute;
  right: 6px;
  bottom: 6px;
  transform: scale(1.3);
}
</style>
</head>

<body>

<h1>ポケモン図鑑番号検定</h1>

<label>モード選択</label>
<select id="mode">
  <option value="name">番号→ポケモン</option>
  <option value="number">ポケモン→番号</option>
</select>

<label>ルール選択</label>
<select id="rule">
  <option value="time">タイムアタック</option>
  <option value="endless">エンドレス</option>
</select>

<label>時間選択</label>
<select id="timeLimit">
  <option value="3">3秒</option>
  <option value="5">5秒</option>
  <option value="10">10秒</option>
  <option value="20">20秒</option>
  <option value="30">30秒</option>
  <option value="60">60秒</option>
</select>

<div class="generations" id="genArea"></div>

<button id="startBtn">ゲーム開始</button>

<div id="gameArea" style="display:none;">
  <div id="timer"></div>
  <div id="question"></div>
  <input id="answer" autocomplete="off">
  <div id="message"></div>
</div>

<div id="result"></div>

<script>
/* ===== 世代定義 ===== */
const generations = [
  {key:"all", label:"全て", range:[1,1025]},
  {key:"kanto", label:"カントー", range:[1,151]},
  {key:"johto", label:"ジョウト", range:[152,251]},
  {key:"hoenn", label:"ホウエン", range:[252,386]},
  {key:"sinnoh", label:"シンオウ", range:[387,493]},
  {key:"unova", label:"イッシュ", range:[494,649]},
  {key:"kalos", label:"カロス", range:[650,721]},
  {key:"alola", label:"アローラ+メルタン", range:[722,809]},
  {key:"galar", label:"ガラル+ヒスイ", range:[810,906]},
  {key:"paldea", label:"パルデア", range:[907,1025]}
];

const genArea = document.getElementById("genArea");

/* ===== チェックボックス生成 ===== */
generations.forEach(g=>{
  const div = document.createElement("div");
  div.className = "gen-box";
  div.innerHTML = `<span>${g.label}</span><input type="checkbox" id="gen-${g.key}">`;
  genArea.appendChild(div);
});

function resetGenerations(){
  generations.forEach(g=>{
    document.getElementById("gen-"+g.key).checked = (g.key==="all");
  });
}
resetGenerations();

/* ===== トグル挙動 ===== */
genArea.addEventListener("change", e=>{
  const rule = document.getElementById("rule").value;
  if(e.target.tagName!=="INPUT") return;

  const id = e.target.id.replace("gen-","");
  const all = document.getElementById("gen-all");

  if(rule==="endless"){
    if(id==="all"){
      const anyChecked = generations.some(g=>g.key!=="all" && document.getElementById("gen-"+g.key).checked);
      generations.forEach(g=>{
        document.getElementById("gen-"+g.key).checked = !anyChecked;
      });
    } else {
      generations.forEach(g=>{
        document.getElementById("gen-"+g.key).checked = false;
      });
      document.getElementById("gen-"+id).checked = true;
    }
  } else {
    if(id!=="all") all.checked = false;
    if(id==="all" && all.checked){
      generations.forEach(g=>{
        document.getElementById("gen-"+g.key).checked = true;
      });
    }
  }
});

/* ===== モード切替時リセット ===== */
document.getElementById("rule").addEventListener("change",()=>{
  resetGenerations();
});

/* ===== ゲーム本体 ===== */
let pokemonList=[];
let current;
let score=0;
let timerId;
let startTime;
let timeLeft;

fetch("pokemon.json")
.then(r=>r.json())
.then(d=>pokemonList=d);

function normalize(str){
  return str.replace(/[ァ-ン]/g,s=>String.fromCharCode(s.charCodeAt(0)-0x60))
            .replace(/[ゔ]/g,"う");
}

document.getElementById("startBtn").onclick=()=>{
  const rule=document.getElementById("rule").value;
  score=0;
  document.getElementById("result").innerHTML="";
  document.getElementById("message").textContent="";
  document.getElementById("gameArea").style.display="block";
  document.getElementById("answer").value="";
  document.getElementById("answer").focus();

  if(rule==="time"){
    timeLeft=Number(document.getElementById("timeLimit").value);
    document.getElementById("timer").textContent="残り時間："+timeLeft+"秒";
    timerId=setInterval(()=>{
      timeLeft--;
      document.getElementById("timer").textContent="残り時間："+timeLeft+"秒";
      if(timeLeft<=0) endGame(true);
    },1000);
  } else {
    startTime=Date.now();
    timerId=setInterval(()=>{
      const t=Math.floor((Date.now()-startTime)/1000);
      document.getElementById("timer").textContent="経過時間："+t+"秒";
    },1000);
  }
  next();
};

function next(){
  const ranges=[];
  generations.forEach(g=>{
    if(document.getElementById("gen-"+g.key).checked && g.key!=="all"){
      ranges.push(g.range);
    }
  });
  if(ranges.length===0){
    current=pokemonList[Math.floor(Math.random()*pokemonList.length)];
  } else {
    const pool=pokemonList.filter(p=>
      ranges.some(r=>p.number>=r[0]&&p.number<=r[1])
    );
    current=pool[Math.floor(Math.random()*pool.length)];
  }

  const mode=document.getElementById("mode").value;
  document.getElementById("question").textContent =
    mode==="name" ? current.number+"番は？" : current.name+" の番号は？";
}

document.getElementById("answer").addEventListener("keydown",e=>{
  if(e.key!=="Enter") return;
  const mode=document.getElementById("mode").value;
  const input=e.target.value.trim();
  if(!input) return;

  const ok =
    mode==="name"
    ? normalize(input)===normalize(current.name)
    : Number(input)===current.number;

  if(ok){
    score++;
    document.getElementById("message").textContent="正解！";
    e.target.value="";
    next();
  } else {
    endGame(false);
  }
});

function endGame(timeup){
  clearInterval(timerId);
  document.getElementById("gameArea").style.display="none";
  document.getElementById("result").innerHTML=
    (timeup?"時間切れ":"不正解")+"<br>答えは「"+current.name+"」<br>スコア："+score;
}
</script>

</body>
</html>
