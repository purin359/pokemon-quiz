<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ポケモン図鑑番号検定</title>

<style>
body {
  font-family: system-ui, sans-serif;
  margin: 0;
  padding: 10px;
  background: #f5f5f5;
}
.container {
  max-width: 500px;
  margin: auto;
  background: white;
  padding: 15px;
  border-radius: 10px;
}
select, input, button {
  width: 100%;
  font-size: 1.1em;
  padding: 10px;
  margin: 8px 0;
}
#status { text-align: center; }
#timer { color: red; font-weight: bold; }
.hidden { display: none; }
</style>
</head>

<body>
<div class="container">
<h1>ポケモン図鑑番号検定</h1>

<label>制限時間</label>
<select id="timeSelect">
  <option value="0">制限時間なし</option>
  <option value="1">1秒</option>
  <option value="2">2秒</option>
  <option value="3">3秒</option>
  <option value="4">4秒</option>
  <option value="5" selected>5秒</option>
  <option value="6">6秒</option>
  <option value="7">7秒</option>
  <option value="8">8秒</option>
  <option value="9">9秒</option>
  <option value="10">10秒</option>
</select>

<button onclick="startGame()">ゲーム開始</button>

<div id="game" class="hidden">
  <div id="status">
    No.<span id="number"></span><br>
    ⏱ <span id="timer">∞</span><br>
    正解数：<span id="score">0</span><br>
    最高記録：<span id="best">0</span>
  </div>

  <input id="answer" list="pokemonList" placeholder="ポケモン名を入力">
  <datalist id="pokemonList"></datalist>
</div>
</div>

<script>
let pokemon = {};
let numbers = [];
let currentNumber = null;
let timer = null;
let timeLeft = 0;
let limit = 5;
let score = 0;
let best = localStorage.getItem("pokemon_best") || 0;

/* ===== DOM取得 ===== */
const answer = document.getElementById("answer");
const pokemonList = document.getElementById("pokemonList");
const numberSpan = document.getElementById("number");
const timerSpan = document.getElementById("timer");
const scoreSpan = document.getElementById("score");
const bestSpan = document.getElementById("best");
const game = document.getElementById("game");
const timeSelect = document.getElementById("timeSelect");

bestSpan.textContent = best;

/* ===== ひらがな→カタカナ ===== */
function hiraToKata(str) {
  return str.replace(/[\u3041-\u3096]/g, ch =>
    String.fromCharCode(ch.charCodeAt(0) + 0x60)
  );
}

/* ===== JSON読み込み ===== */
fetch("pokemon.json")
  .then(r => r.json())
  .then(data => {
    pokemon = data;
    numbers = Object.keys(pokemon);
  })
  .catch(() => alert("pokemon.json の読み込みに失敗しました"));

/* ===== ゲーム開始 ===== */
function startGame() {
  score = 0;
  limit = Number(timeSelect.value);
  scoreSpan.textContent = score;
  game.classList.remove("hidden");
  nextQuestion();
}

/* ===== 次の問題 ===== */
function nextQuestion() {
  clearInterval(timer);

  currentNumber = numbers[Math.floor(Math.random() * numbers.length)];
  numberSpan.textContent = currentNumber;

  if (limit === 0) {
    timerSpan.textContent = "∞";
  } else {
    timeLeft = limit;
    timerSpan.textContent = timeLeft;
    timer = setInterval(() => {
      timeLeft--;
      timerSpan.textContent = timeLeft;
      if (timeLeft <= 0) gameOver("時間切れ");
    }, 1000);
  }

  answer.value = "";
  answer.focus();
}

/* ===== 入力時：ひらがな→カタカナ + 予測 ===== */
answer.addEventListener("input", () => {
  // ★ 入力文字を即カタカナに変換
  answer.value = hiraToKata(answer.value);

  pokemonList.innerHTML = "";
  if (!answer.value) return;

  numbers.forEach(n => {
    if (pokemon[n].startsWith(answer.value)) {
      const o = document.createElement("option");
      o.value = pokemon[n];
      pokemonList.appendChild(o);
    }
  });
});

/* ===== Enter判定 ===== */
answer.addEventListener("keydown", e => {
  if (e.key === "Enter") checkAnswer();
});

/* ===== 判定 ===== */
function checkAnswer() {
  if (answer.value === pokemon[currentNumber]) {
    score++;
    scoreSpan.textContent = score;
    nextQuestion();
  } else {
    gameOver("不正解");
  }
}

/* ===== ゲームオーバー ===== */
function gameOver(msg) {
  clearInterval(timer);
  if (score > best) {
    best = score;
    localStorage.setItem("pokemon_best", best);
  }
  alert(`${msg}\nスコア：${score}`);
  bestSpan.textContent = best;
  game.classList.add("hidden");
}
</script>
</body>
</html>
